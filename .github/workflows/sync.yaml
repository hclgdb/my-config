name: Auto Sync Configs

on:
  # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 8:00 è¿è¡Œ (UTC 0:00)
  schedule:
    - cron: '0 0 * * *'
  # å…è®¸æ‰‹åŠ¨è§¦å‘ (åœ¨ Actions é¡µé¢ç‚¹å‡» Run workflow)
  workflow_dispatch:
    inputs:
      force_overwrite_ai:
        description: 'å¼ºåˆ¶è¦†ç›–AIé…ç½® (æ…ç”¨ï¼ä¼šè¦†ç›–è‡ªå®šä¹‰çš„AIåˆ†ç±»)'
        required: false
        default: false
        type: boolean
      create_pr_on_conflict:
        description: 'æ£€æµ‹åˆ°AIé…ç½®å†²çªæ—¶åˆ›å»ºPRè€Œä¸æ˜¯ç›´æ¥æ¨é€'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout My Repo
        uses: actions/checkout@v4

      - name: Sync from Upstreams
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯ï¼ˆç”¨äºæäº¤ä»£ç ï¼‰
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

          # åˆ›å»ºä¸´æ—¶å·¥ä½œåŒº
          mkdir -p temp_work
          
          # ----------------------------------------------------------------
          # 1. å¤„ç† YaNet (åªå– Mihomo ä¸‹çš„ä¸€ä¸ª JS æ–‡ä»¶)
          # ----------------------------------------------------------------
          echo ">>> Syncing YaNet..."
          # æµ…å…‹éš†(depth=1)åªä¸‹è½½æœ€æ–°ç‰ˆï¼Œé€Ÿåº¦æå¿«
          git clone --depth 1 --branch main https://github.com/dahaha-365/YaNet.git temp_work/yanet
          
          # å¼ºåˆ¶è¦†ç›–é‚£ä¸ªç‰¹å®šçš„ JS æ–‡ä»¶
          cp -f temp_work/yanet/Mihomo/global_script.js scripts/YaNet/global_script.js || echo "YaNet script not found!"
          
          # ----------------------------------------------------------------
          # 2. å¤„ç† Blackmatrix (Rules å’Œ Icons) - æ™ºèƒ½åŒæ­¥
          # ----------------------------------------------------------------
          echo ">>> Syncing Blackmatrix..."
          git clone --depth 1 --branch master https://github.com/blackmatrix7/ios_rule_script.git temp_work/bm
          
          # AIé…ç½®å¤„ç†é€»è¾‘
          PROTECTED_DIRS=("OpenAI" "Anthropic" "Gemini" "Copilot" "AI" "GlobalMedia")
          FORCE_OVERWRITE="${{ github.event.inputs.force_overwrite_ai }}"
          CREATE_PR_ON_CONFLICT="${{ github.event.inputs.create_pr_on_conflict }}"
          
          # æ£€æµ‹AIé…ç½®å†²çª
          echo ">>> Checking for AI configuration conflicts..."
          AI_CONFLICTS=false
          for dir in "${PROTECTED_DIRS[@]}"; do
            if [ -d "rules/$dir" ] && [ -d "temp_work/bm/rule/Clash/$dir" ]; then
              # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å·®å¼‚
              if ! diff -r "rules/$dir" "temp_work/bm/rule/Clash/$dir" >/dev/null 2>&1; then
                echo "âš ï¸  Conflict detected in: $dir"
                AI_CONFLICTS=true
              fi
            fi
          done
          
          if [ "$AI_CONFLICTS" = true ] && [ "$FORCE_OVERWRITE" != "true" ]; then
            echo "ğŸ›‘ AIé…ç½®å†²çªæ£€æµ‹åˆ°ï¼"
            echo "é€‰é¡¹1: æ‰‹åŠ¨è§¦å‘æ—¶å‹¾é€‰ 'force_overwrite_ai' å¼ºåˆ¶è¦†ç›–"
            echo "é€‰é¡¹2: è®©å·¥ä½œæµåˆ›å»ºPRä¾›æ‚¨å®¡æ ¸ (å½“å‰è®¾ç½®: $CREATE_PR_ON_CONFLICT)"
            
            if [ "$CREATE_PR_ON_CONFLICT" = "true" ]; then
              echo "ğŸ“ å°†åˆ›å»ºPRæ¨¡å¼ï¼Œä¿ç•™å†²çªæ–‡ä»¶ä¾›æ‰‹åŠ¨è§£å†³..."
              # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œåç»­åˆ›å»ºPR
              echo "SHOULD_CREATE_PR=true" >> $GITHUB_ENV
              echo "AI_CONFLICTS_DETECTED=true" >> $GITHUB_ENV
            else
              echo "âŒ åŒæ­¥ä¸­æ­¢ï¼Œè¯·æ‰‹åŠ¨è§£å†³å†²çªæˆ–è°ƒæ•´è®¾ç½®"
              exit 1
            fi
          fi
          
          if [ "$FORCE_OVERWRITE" = "true" ] || [ "$AI_CONFLICTS" = false ]; then
            # æ­£å¸¸åŒæ­¥æµç¨‹
            echo ">>> Syncing rules (normal mode)..."
            rsync -av temp_work/bm/rule/Clash/ rules/
          else
            # å†²çªæ¨¡å¼ï¼šå¤‡ä»½å¹¶éƒ¨åˆ†åŒæ­¥
            echo ">>> Backing up existing AI configurations..."
            mkdir -p temp_work/backup
            for dir in "${PROTECTED_DIRS[@]}"; do
              if [ -d "rules/$dir" ]; then
                cp -r "rules/$dir" "temp_work/backup/"
                echo "Backed up: $dir"
              fi
            done
            
            # åŒæ­¥é™¤AIå¤–çš„å…¶ä»–è§„åˆ™
            echo ">>> Syncing non-AI rules..."
            rsync -av temp_work/bm/rule/Clash/ rules/ \
              --exclude="OpenAI/" \
              --exclude="Anthropic/" \
              --exclude="Gemini/" \
              --exclude="Copilot/" \
              --exclude="AI/" \
              --exclude="GlobalMedia/"
            
            # æ¢å¤åŸæœ‰AIé…ç½®
            echo ">>> Restoring existing AI configurations..."
            for dir in "${PROTECTED_DIRS[@]}"; do
              if [ -d "temp_work/backup/$dir" ]; then
                cp -r "temp_work/backup/$dir" "rules/"
                echo "Restored: $dir"
              fi
            done
            
            # åŒæ—¶ä¿å­˜ä¸Šæ¸¸çš„AIé…ç½®ä¾›å¯¹æ¯”
            echo ">>> Saving upstream AI configs for manual review..."
            mkdir -p temp_work/upstream_ai
            for dir in "${PROTECTED_DIRS[@]}"; do
              if [ -d "temp_work/bm/rule/Clash/$dir" ]; then
                cp -r "temp_work/bm/rule/Clash/$dir" "temp_work/upstream_ai/"
                echo "Saved upstream $dir for comparison"
              fi
            done
          fi
          
          # åŒæ­¥ Icons
          rsync -av temp_work/bm/icon/color/ icons/
          
          # ----------------------------------------------------------------
          # 3. å¤„ç† Sirkey (æ•´ä¸ªä»“åº“)
          # ----------------------------------------------------------------
          echo ">>> Syncing Sirkey..."
          git clone --depth 1 --branch main https://github.com/sirkey5/clash--singbox--subsotre.js.git temp_work/sirkey
          
          # æ’é™¤ .git æ–‡ä»¶å¤¹ï¼Œå¤åˆ¶æ‰€æœ‰å†…å®¹åˆ° scripts/Sirkey
          rsync -av --exclude='.git' temp_work/sirkey/ scripts/Sirkey/
          
          # ----------------------------------------------------------------
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          # ----------------------------------------------------------------
          rm -rf temp_work

      - name: Create Conflict Resolution Files
        if: env.AI_CONFLICTS_DETECTED == 'true'
        run: |
          # åˆ›å»ºå†²çªè§£å†³æŒ‡å—æ–‡ä»¶
          cat > CONFLICT_RESOLUTION.md << 'EOF'
          # ğŸš¨ AIé…ç½®å†²çªæ£€æµ‹æŠ¥å‘Š
          
          ## å†²çªæ¦‚è¿°
          æ£€æµ‹åˆ°ä»¥ä¸‹AIç›¸å…³é…ç½®å­˜åœ¨å†²çªï¼Œéœ€è¦æ‰‹åŠ¨å®¡æ ¸ï¼š
          
          EOF
          
          # è®°å½•å…·ä½“å†²çª
          PROTECTED_DIRS=("OpenAI" "Anthropic" "Gemini" "Copilot" "AI" "GlobalMedia")
          for dir in "${PROTECTED_DIRS[@]}"; do
            if [ -d "rules/$dir" ] && [ -d "temp_work/upstream_ai/$dir" ]; then
              if ! diff -r "rules/$dir" "temp_work/upstream_ai/$dir" >/dev/null 2>&1; then
                echo "### ğŸ“ $dir" >> CONFLICT_RESOLUTION.md
                echo "- å½“å‰é…ç½®: \`rules/$dir/\`" >> CONFLICT_RESOLUTION.md
                echo "- ä¸Šæ¸¸é…ç½®: \`temp_work/upstream_ai/$dir/\`" >> CONFLICT_RESOLUTION.md
                echo "" >> CONFLICT_RESOLUTION.md
                
                # ä¿å­˜ä¸Šæ¸¸é…ç½®åˆ°å¯æ¯”è¾ƒçš„ä½ç½®
                cp -r "temp_work/upstream_ai/$dir" "rules/${dir}_upstream_$(date +%Y%m%d)"
                echo "âœ… ä¸Šæ¸¸é…ç½®å·²ä¿å­˜ä¸º: rules/${dir}_upstream_$(date +%Y%m%d)" >> CONFLICT_RESOLUTION.md
              fi
            fi
          done
          
          cat >> CONFLICT_RESOLUTION.md << 'EOF'
          
          ## è§£å†³æ–¹æ¡ˆ
          
          ### æ–¹å¼1: æ‰‹åŠ¨æ¯”è¾ƒå’Œåˆå¹¶
          1. ä½¿ç”¨ VS Code æˆ–å…¶ä»–å·¥å…·æ¯”è¾ƒ `rules/AIç›®å½•/` å’Œ `rules/AIç›®å½•_upstream_æ—¥æœŸ/`
          2. æ‰‹åŠ¨é€‰æ‹©è¦ä¿ç•™çš„è§„åˆ™
          3. åˆ é™¤ä¸éœ€è¦çš„ `*_upstream_*` æ–‡ä»¶å¤¹
          4. æäº¤æ›´æ”¹
          
          ### æ–¹å¼2: é€‰æ‹©ä¿ç•™æŸä¸€ç‰ˆæœ¬
          ```bash
          # ä¿ç•™å½“å‰ç‰ˆæœ¬ï¼ˆåˆ é™¤ä¸Šæ¸¸ç‰ˆæœ¬ï¼‰
          find rules/ -name "*_upstream_*" -type d -exec rm -rf {} +
          
          # æˆ–è€…ä½¿ç”¨ä¸Šæ¸¸ç‰ˆæœ¬ï¼ˆæ›¿æ¢å½“å‰ç‰ˆæœ¬ï¼‰
          # for dir in rules/*_upstream_*; do
          #   original=${dir/_upstream_*/}
          #   rm -rf "$original"
          #   mv "$dir" "$original"
          # done
          ```
          
          ### æ–¹å¼3: ä¸‹æ¬¡å¼ºåˆ¶è¦†ç›–
          åœ¨ GitHub Actions ä¸­æ‰‹åŠ¨è§¦å‘åŒæ­¥æ—¶ï¼Œå‹¾é€‰ "å¼ºåˆ¶è¦†ç›–AIé…ç½®" é€‰é¡¹
          
          EOF
          
          echo "ğŸ“ å†²çªè§£å†³æŒ‡å—å·²åˆ›å»º: CONFLICT_RESOLUTION.md"

      - name: Commit and Push changes
        run: |
          # æŸ¥çœ‹çŠ¶æ€å’Œå˜æ›´ç»Ÿè®¡
          echo ">>> Checking sync results..."
          git status
          
          # ç»Ÿè®¡å˜æ›´æ–‡ä»¶æ•°é‡
          ADDED=$(git status --porcelain | grep "^A" | wc -l)
          MODIFIED=$(git status --porcelain | grep "^M" | wc -l)
          DELETED=$(git status --porcelain | grep "^D" | wc -l)
          
          echo "Files added: $ADDED, modified: $MODIFIED, deleted: $DELETED"
          
          # æ˜¾ç¤ºå—ä¿æŠ¤çš„AIæ–‡ä»¶å¤¹çŠ¶æ€
          echo ">>> Protected AI directories status:"
          for dir in OpenAI Anthropic Gemini Copilot AI GlobalMedia; do
            if [ -d "rules/$dir" ]; then
              COUNT=$(find "rules/$dir" -name "*.yaml" -o -name "*.list" | wc -l)
              echo "  $dir: $COUNT files (protected)"
            fi
          done
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add .
          
          # æ£€æµ‹æ˜¯å¦æœ‰å˜æ›´å¹¶æäº¤
          if ! git diff --staged --quiet; then
            if [ "$SHOULD_CREATE_PR" = "true" ]; then
              # å†²çªæ¨¡å¼ï¼šåˆ›å»ºPR
              BRANCH_NAME="auto-sync-conflict-$(date +'%Y%m%d-%H%M%S')"
              
              # åˆ›å»ºæ–°åˆ†æ”¯
              git checkout -b "$BRANCH_NAME"
              
              # æäº¤åˆ°æ–°åˆ†æ”¯
              COMMIT_MSG="ğŸ”„ Auto sync with AI config conflicts ($(date +'%Y-%m-%d'))

              ğŸ“Š Changes: +$ADDED ~$MODIFIED -$DELETED files
              âš ï¸  AIé…ç½®å†²çªéœ€è¦æ‰‹åŠ¨è§£å†³
              ğŸ” è¯·æŸ¥çœ‹ CONFLICT_RESOLUTION.md è·å–è¯¦ç»†ä¿¡æ¯
              
              ğŸ”„ Synced from:
              - blackmatrix7/ios_rule_script  
              - dahaha-365/YaNet
              - sirkey5/clash--singbox--subsotre.js
              
              ğŸ’¡ ä¸Šæ¸¸AIé…ç½®å·²ä¿å­˜ä¸º *_upstream_* æ–‡ä»¶å¤¹ä¾›å¯¹æ¯”"
              
              git commit -m "$COMMIT_MSG"
              git push -u origin "$BRANCH_NAME"
              
              echo "ğŸ”€ PRåˆ†æ”¯å·²åˆ›å»º: $BRANCH_NAME"
              echo "ğŸ“ è¯·æ‰‹åŠ¨å®¡æ ¸å’Œåˆå¹¶ï¼Œæˆ–è€…é‡æ–°è¿è¡Œå·¥ä½œæµå¹¶å‹¾é€‰'å¼ºåˆ¶è¦†ç›–AIé…ç½®'"
              
            else
              # æ­£å¸¸æ¨¡å¼ï¼šç›´æ¥æ¨é€
              FORCE_FLAG=""
              if [ "${{ github.event.inputs.force_overwrite_ai }}" = "true" ]; then
                FORCE_FLAG=" (AIé…ç½®å·²å¼ºåˆ¶è¦†ç›–)"
              fi
              
              COMMIT_MSG="Auto sync: Update configs from upstream $(date +'%Y-%m-%d')$FORCE_FLAG

              ğŸ“Š Changes: +$ADDED ~$MODIFIED -$DELETED files
              ğŸ›¡ï¸  Protected AI classifications preserved
              ğŸ”„ Synced from: blackmatrix7/ios_rule_script, dahaha-365/YaNet, sirkey5/clash--singbox--subsotre.js
              
              [skip ci]"
              
              git commit -m "$COMMIT_MSG"
              git push
              echo "âœ… Changes pushed successfully!"
            fi
          else
            echo "â„¹ï¸  No changes detected. Skipping push."
          fi